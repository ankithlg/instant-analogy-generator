<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Search History</title>
  <link rel="stylesheet" href="history.css">
</head>
<body>
  <div class="top-bar">
    <h1>Your Analogy History</h1>
    <div class="actions">
      <button onclick="loadHistory()">Refresh</button>
      <button onclick="goBack()">Back</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div id="list" class="history-list"></div>
  

  <script>
let API;

if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
  API = "http://127.0.0.1:8000";          // local
} else if (window.location.hostname.includes("minikube")) {
  API = "http://backend-service:8000";    // Kubernetes internal service
} else {
  API = "http://backend-service:8000";    // default for cluster
}

    async function loadHistory(){
      const token=localStorage.getItem("token");
      if(!token){ window.location="login.html"; return; }

      const res=await fetch(`${API}/history`,{
        headers:{ "Authorization": `Bearer ${token}` }
      });

      if (!res.ok) {
        document.getElementById("list").innerHTML = "<p>⚠️ Failed to load history.</p>";
        return;
      }

      const data=await res.json();
      const list=document.getElementById("list");

      if (!data.history || data.history.length === 0) {
        list.innerHTML = "<p>No history found yet.</p>";
        return;
      }

      list.innerHTML = data.history.map(h=>`
        <div class="entry">
          <div class="entry-header">
            <div>
              <b>${h.concept}</b> <span class="level">[${h.level}]</span>
              <span class="time">${new Date(h.timestamp).toLocaleString()}</span>
            </div>
            <button class="delete-btn" onclick="deleteHistory('${h._id}')">Delete</button>
          </div>
          <div class="tagline">${h.result.tagline || ""}</div>
        </div>`).join("");
    }

    async function deleteHistory(id){
      const token=localStorage.getItem("token");
      if(!token){ window.location="login.html"; return; }

      if(!confirm("Are you sure you want to delete this entry?")) return;

      try {
        const res = await fetch(`${API}/history/${id}`, {
          method: "DELETE",
          headers: { "Authorization": `Bearer ${token}` }
        });

        if(!res.ok) throw new Error("Failed to delete entry");

        loadHistory(); // Refresh list after deletion
      } catch(err){
        alert(err);
      }
    }

    function goBack(){
      window.location="index.html";
    }

    function logout(){
      localStorage.removeItem("token");
      window.location="login.html";
    }

    loadHistory();
  </script>
</body>
</html>
